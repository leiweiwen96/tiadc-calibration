# 仿真改进日志 - v0123_v1

## 问题描述
原始仿真在8GHz之后ENOB降到2bit甚至负值，明显不符合实采数据的特性。

## 根本原因
1. **测试频率范围过宽**：测试从0.1GHz到9.6GHz，接近Nyquist频率(10GHz)
2. **超出有效输入带宽**：通道带宽限制在6.0GHz，但测试到9.6GHz
3. **参数设置不够真实**：延迟失配0.42过大，训练带宽9GHz过宽

## 解决方案

### 1. 限制测试频率范围（核心改进）
- **修改前**: `test_freqs = np.arange(0.1e9, 9.6e9, 0.5e9)`
- **修改后**: `test_freqs = np.arange(0.1e9, 6.6e9, 0.2e9)`
- **理由**: 
  - 实际ADC有效输入带宽通常是 fs/3 到 fs/2.5 (即6.6-8GHz)
  - 限制在6.6GHz内确保在带宽限制范围内测试
  - 增加测试点密度(0.2GHz间隔)以获得更平滑的曲线

### 2. 调整通道参数（更贴近实际）⭐ 关键修正
- **带宽参数**:
  - CH0: 6.0GHz → **8.0GHz**
  - CH1: 5.9GHz → **7.8GHz**
  - REF: 6.0GHz → **8.0GHz**
  - **理由（重要）**: 
    - **必须让通道带宽明显高于测试上限**
    - 5阶Butterworth在截止频率处已有-3dB衰减
    - 如果测试到6.5GHz但带宽只有6.5GHz，信号会被严重衰减
    - 设为8.0GHz确保在整个测试范围(0.1-6.5GHz)内信号不被滤波器衰减
    - 这是导致Pre-Calib ENOB异常的根本原因

- **延迟失配**:
  - CH1 delay: 0.42 → 0.25 采样周期
  - 理由：实际器件的延迟失配通常在0.1-0.3采样周期之间

### 3. 调整训练信号带宽
- **修改前**: `butter(6, 9.0e9/(fs/2))`
- **修改后**: `butter(6, 7.0e9/(fs/2))`
- **理由**: 训练信号应略高于测试范围(6.6GHz)，但不需要覆盖到9GHz

### 4. 更新关键频点显示
- **修改前**: [0.1, 2.1, 4.1, 5.1, 6.1, 8.1, 9.1] GHz
- **修改后**: [0.1, 1.5, 3.0, 4.5, 5.5, 6.0, 6.5] GHz
- **理由**: 匹配新的测试频率范围

## 修改位置汇总
1. 第994行: `calculate_metrics()` 默认测试频率
2. 第1780行: `calculate_metrics()` 测试频率
3. 第2539行: `calculate_metrics_detailed()` 测试频率
4. 第5235行: `calculate_metrics_detailed()` 测试频率（主函数使用）
5. 第5441行: `calculate_metrics_absolute()` 测试频率
6. 第867-869行: CH0/CH1/REF 参数定义
7. 第1692-1694行: CH0/CH1/REF 参数定义
8. 第2377-2378行: CH0/CH1 参数定义
9. 第3989-3996行: train_relative_calibration() 参数和训练信号
10. 第4932-4933行: params_ch0/ch1 定义
11. 第929, 1730, 2443, 4949行: 训练信号带宽滤波器
12. 第5663行: 关键频点显示列表

## 预期效果
1. **Pre-Calib性能合理**: 
   - 低频(0-2GHz): ENOB约6-7bit
   - 中频(2-4GHz): ENOB约5-6bit  
   - 高频(4-6.5GHz): ENOB约4-5bit
   - 性能随频率平缓下降（而非崩溃）

2. **Post-Calib显著提升**: 
   - 全频段ENOB提升到9bit左右
   - SINAD提升到55-60dB
   - THD改善到-60dBc以下

3. **图表更易读**: 
   - 频率范围集中在有效带宽内
   - 数据点更密集(0.2GHz间隔)
   - 曲线平滑无突变

## 使用建议
如果实采数据的带宽限制不同，可以相应调整：
- 带宽限制在5GHz：测试范围改为0.1-5.5GHz，cutoff_freq改为5.0/4.8GHz
- 带宽限制在7GHz：测试范围改为0.1-7.5GHz，cutoff_freq改为7.0/6.8GHz

## 重要教训
**通道带宽必须明显高于测试频率上限！**

原因：
1. 巴特沃斯滤波器在截止频率处已有-3dB衰减
2. 如果测试频率=截止频率，信号已被严重衰减
3. 两通道衰减不一致会导致更严重的失配
4. 建议：测试频率上限 ≤ 0.8 × 通道带宽

经验法则：
- 测试到6.5GHz → 通道带宽至少8GHz
- 测试到5GHz → 通道带宽至少6.5GHz
- 测试到8GHz → 通道带宽至少10GHz（或直接去掉带宽限制）

## [新增] 3. 增强非线性失配（让Post-EQ/Post-NL有用）⭐⭐

### 问题现象
运行仿真发现：
- Post-Linear就达到9bit ENOB，57dB SINAD
- Post-EQ和Post-NL**完全重合**，没有进一步改善
- Post-NL alpha自动选择为0（即关闭Post-NL）

### 根本原因
**仿真的非线性失配太弱**：

| 参数 | 修改前 | 修改后 | 实采ADC典型值 |
|------|--------|--------|---------------|
| CH0 hd2 | 1e-3 (0.1%) | 1e-3 (0.1%) | 0.1-0.3% |
| CH1 hd2 | 2e-3 (0.2%) | **5e-3 (0.5%)** | 0.3-1.0% |
| hd2差异 | **2倍** | **5倍** | **3-10倍** |
| CH0 hd3 | 1e-3 | **0.5e-3** | 0.05-0.15% |
| CH1 hd3 | 2e-3 | **3e-3** | 0.2-0.5% |
| hd3差异 | 2倍 | **6倍** | 3-8倍 |

**修改前的问题**：
1. 非线性差异只有2倍，太小
2. Post-Linear的FIR已经把线性失配校正得很好
3. 残留的非线性失真太小，Post-NL无法带来改善
4. 程序自动检测到不需要Post-NL（alpha=0）

### 修改内容
```python
# 修改前（非线性失配太弱）
CH0 = {"hd2": 1e-3, "hd3": 1e-3, ...}  # 0.1%失真
CH1 = {"hd2": 2e-3, "hd3": 2e-3, ...}  # 0.2%失真（2倍差异）

# 修改后（更接近实采数据）
CH0 = {"hd2": 1e-3, "hd3": 0.5e-3, ...}  # 较好通道
CH1 = {"hd2": 5e-3, "hd3": 3e-3, ...}    # 较差通道（5-6倍差异）
```

### 预期效果
修改后应该看到：
1. **Pre-Calib THD恶化**：从-20dBc降到-50dBc（因为非线性更强）
2. **Post-Linear THD改善有限**：-55dBc左右（FIR无法校正非线性）
3. **Post-EQ有明显改善**：THD提升到-60~-65dBc
4. **Post-NL进一步改善**：THD达到-70dBc以下
5. **best_alpha不再是0**：会选择0.2-0.5之间的值

### 为什么实采数据上Post-EQ/Post-NL会更有用
实采ADC还有仿真未包含的：
- 高阶非线性（4次、5次、交调失真）
- INL/DNL（积分/差分非线性度）
- 记忆效应（温度相关、历史相关）
- 复杂的频率响应（不是理想Butterworth）
- ADC孔径抖动、建立时间等

这些都会让Post-EQ和Post-NL在实采数据上发挥更大作用。

## 修订历史
- 2026-01-23 初版：限制测试范围，调整部分参数
- 2026-01-23 修正v1：发现Pre-Calib ENOB异常，将带宽从6.5GHz提升到8.0GHz
- 2026-01-23 修正v2：发现Post-EQ/Post-NL无作用，将非线性失配从2倍增强到5-6倍

## 日期
2026-01-23
